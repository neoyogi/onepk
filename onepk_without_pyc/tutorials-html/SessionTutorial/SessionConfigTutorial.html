<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at Aug 18, 2014
 | Rendered using Apache Maven Fluido Skin 1.2.2
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>onePK Python Tutorials - Session Tutorial - Configuring the parameters of connections and using
sessions.</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido.min.js"></script>

    
    <meta http-equiv="Content-Language" content="en" />
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>onePK Python Tutorials</h2>
                </div>
                      </div>
        <div class="pull-right">                  <a href="http://www.cisco.com/go/onepk" id="bannerRight">
                                                                                                <img src="../images/cisco-logo.png" />
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
            
                  <li id="publishDate">Last Published: 2014-08-18</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 1.3.0.181</li>
                      
                
            
      
                            </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
            
                                    <h3>Main</h3>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Home">Home</a>
            </li>
          </ul>
                        <h3>Tutorials</h3>
                  <ul>
                  <li class="none">
                          <a href=".././basetutorial.html" title="Connecting to a Network Element">Connecting to a Network Element</a>
            </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <li class="expanded">
                          <a href="../index.html#Base_Service_Set_Tutorials" title="Base Service Set Tutorials">Base Service Set Tutorials</a>
                    <ul>
                                                                                  <li class="expanded">
                          <a href="../SessionTutorial/SessionTutorials.html" title="Session Handling">Session Handling</a>
                    <ul>
                      <li class="none">
            <strong>Session Handling Tutorial</strong>
          </li>
              </ul>
        </li>
                                                                                                            <li class="collapsed">
                          <a href="../NetworkElement/networkelement.html" title="Element">Element</a>
                  </li>
                                                                                                                                                <li class="collapsed">
                          <a href="../NetworkInterface/networkinterface.html" title="Network Interface">Network Interface</a>
                  </li>
                                                                                                                                                                  <li class="collapsed">
                          <a href="../Events/events.html" title="Events">Events</a>
                  </li>
                                                                                          <li class="collapsed">
                          <a href="../Discovery/discovery.html" title="Discovery">Discovery</a>
                  </li>
                                                                                          <li class="collapsed">
                          <a href="../Management/management.html" title="Application CLI Extension">Application CLI Extension</a>
                  </li>
                                                                                          <li class="collapsed">
                          <a href="../AAATutorial/AAAOverview.html" title="AAA">AAA</a>
                  </li>
                                                                        <li class="collapsed">
                          <a href="../VTYTutorial/vty.html" title="VTY">VTY</a>
                  </li>
                                                                                          <li class="collapsed">
                          <a href="../Policy/policy.html" title="Policy">Policy</a>
                  </li>
                                                                                          <li class="collapsed">
                          <a href="../Routing/routing.html" title="Routing">Routing</a>
                  </li>
                                                                        <li class="collapsed">
                          <a href="../Location/location.html" title="Location">Location</a>
                  </li>
                                                                        <li class="collapsed">
                          <a href="../Identity/identity.html" title="Identity">Identity</a>
                  </li>
              </ul>
        </li>
          </ul>
                      
            
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section"><h2><a name="Session_Tutorial">Session Tutorial</a></h2>
<p><a href="mailto:onePK-feedback@cisco.com?subject=Python tutorials" class="externalLink">Feedback</a></p>
<p><b>Contents</b></p>
<ul><li><a href="#Session_Tutorial">Session Tutorial</a></li>
<li><a href="#Goal">Goal</a></li>
<li><a href="#Tutorial_Code">Tutorial Code</a></li>
<li><a href="#RequirementsPrerequisites">Requirements/Prerequisites</a></li>
<li><a href="#Steps_In_Detail">Steps In Detail</a><ul><li><a href="#Connecting_to_the_Network_Element">Connecting to the Network Element</a></li>
</ul>
</li>
<li><a href="#Result">Result</a></li>
<li><a href="#Next_Steps">Next Steps</a></li>
</ul>
</div>
<div class="section"><h2><a name="Goal">Goal</a></h2>
<p>This tutorial is intended for application developers who need more fine-grained control over the connections made between onePK applications and network elements.</p>
<p>In onePK, a session represents an authenticated channel of communication between an application and a network element. This tutorial demonstrates how to configure a session, get the properties and statistics of a session.</p>
</div>
<div class="section"><h2><a name="Tutorial_Code">Tutorial Code</a></h2>
<p>The code used in this tutorial is located under &lt;SDK Location&gt;/python/tutorials/session/.</p>
</div>
<div class="section"><h2><a name="RequirementsPrerequisites">Requirements/Prerequisites</a></h2>
<p>This tutorial assumes the application can connect properly to a network element. Please see the <a href="../basetutorial.html">Connecting to a Network Element</a> tutorial for information on how to make the initial connection.</p>
<p><b>NOTE:</b> You are recommended to use TLS (Transport Layer Security) to enable secure communications between your applications and connected devices. For information about configuring TLS on your connected network element and enabling onePK TLS communication, see <i>onePK Security</i> in the <i>Getting Started with onePK</i> guide.</p>
</div>
<div class="section"><h2><a name="Steps_In_Detail">Steps In Detail</a></h2>
<div class="section"><h3><a name="Connecting_to_the_Network_Element">Connecting to the Network Element</a></h3>
<p>When connecting to a network element, the caller may optionally provide a SessionConfig that contains the required configuration for the resulting session. When creating the SessionConfig, the only required attribute is the transport mode. </p>
<ul><li>TLS is the transport mode used for the end node hosting model. TLS (Transport Layer Security) provides encrypted communication with certificate authentication services for onePK applications. You are highly recommended to adopt the use of TLS for your application communications to connected devices. By default, the tutorial code runs with the TLS option set, with uni-directional authentication on the connected devices only. To ensure that your tutorial code can run using TLS, you need to:<ul><li>Configure TLS on your router </li>
<li>Enable onePK TLS communication</li>
<li>Set the TLS communication option in your onePK application</li>
</ul>
</li>
</ul>
<p>For detailed information about setting up TLS communication, see <i>onePK Security</i> in the <i>Getting Started with onePK</i> Guide. </p>
<ul><li>TIPC (sometimes referred to as LOCAL) may be used in process and blade hosting models. TIPC (Transparent Inter-Process Communication) is an open source protocol that enables applications in a clustered NOS environment to communicate with other applications in the cluster. TIPC provides location transparency of services in a network and reliable transport taking advantage of standard socket interface support. It also provides connectionless, connected-oriented, and multicast messaging. For more information about TIPC, see <a href="http://tipc.sourceforge.net/docs_user.shtml" class="externalLink"><i>TIPC User Documentation</i> at SourceForge.net.</a> </li>
</ul>
<p>In case of TLS verification failure, pinning can be used to proceed with connection. Pinning is the process by which certain hosts can be whitelisted for TLS verification. If the presented certificate matches the known certificate for that host in the pinning file/DB, that connection proceeds even if the certificate fails the customary TLS verification. Using a handler for unverified TLS hosts, an application may present a fingerprint of the unknown host to a user for manual verification. User can setTLSPinning on the config to make use of pinning feature.</p>
<p>All other attributes are optional, and will take on their default values if not explicitly set. To demonstrate reconnecting to the session, the reconnect timer will be set to one minute.</p>
<div class="source"><pre class="prettyprint">#  Construct a SessionConfig instance with the given transport mode. 
config = SessionConfig(mode)
#  Set the reconnect timer to one minute. 
config.reconnectTimer = 60
#  The session attributes below this point are set to their default
#  values.
#          
#  Set the port to connect to on the network element.
#  TLS      15002
#  TIPC     N/A
#          
if mode.lower() == &quot;tls&quot;:
    config.port = config.DEFAULT_PORT
    config.transportMode = SessionConfig.SessionTransportMode.TLS
    config.ca_certs = tutorial.root_cert_path
    config.keyfile = tutorial.client_key_path
    config.certfile = tutorial.client_cert_path
else:
    #  Not required for TIPC.
    pass
#  Set the event queue size of the session. 
config.eventQueueSize = config.DEFAULT_EVENT_QUEUE_SIZE
#  Set the event thread pool size of the session. 
config.eventThreadPool = config.DEFAULT_THREADPOOL_SIZE
#  Set the event drop mode of the session. 
config.eventDropMode = config.DEFAULT_EVENT_DROP_MODE
#  Set the keepalive attributes of the session. 
#  Idle time in seconds 
config.keepAliveIdleTime = config.DEFAULT_KEEPALIVE_IDLE_TIME
#  Interval between keepalives in seconds 
config.keepAliveInterval = config.DEFAULT_KEEPALIVE_INTERVAL
#  Number of keepalives 
config.keepAliveRetryCount = config.DEFAULT_KEEPALIVE_RETRY_COUNT
</pre>
</div>
<p>Connect to the element using the given session configuration. If no configuration is specified by the caller (i.e. null is used), the session will take on the default values.</p>
<div class="source"><pre class="prettyprint">handle = networkElement.connect(tutorial.get_username(), tutorial.get_password(), config)
</pre>
</div>
<p>Upon receipt of a certificate which could not be verified, this handler asks the application whether to accept the connection and/or whether to add the host to the pinning database. By default, the connection will be terminated and the pinning db will remain unchanged. See a sample handler in below code snippet. </p>
<div class="source"><pre class="prettyprint">if  changed:
    msg = &quot;\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n&quot;
    msg +=&quot;WARNING: THE CERTIFICATE PRESENTED BY REMOTE HOST '%s'\n IS DIFFERENT FROM THE ONE PREVIOUSLY ACCEPTED&quot; %(host)
    msg +=&quot;\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&quot;
else:
    msg = &quot;WARNING: Certificate presented by remote host '%s' is not verified.&quot;%(host)
msg += &quot;\n\nThe %s fingerprint sent by the remote host(%s) is:\n%s&quot; %(hashtype, host, finger_print)
msg += &quot;\n\nYou MUST verify the certificate on remote host before proceeding! \n&quot;
msg += &quot;\nChoose from following options:&quot;

if self.pinning_file:
    prompt = &quot;\nAccept and Pin (p), Accept Once (o), Reject (r) (default) :&quot;
else:
    prompt = &quot;\nAccept Once (o), Reject (r) (default) :&quot;

sys.stdout.write(msg)
self.decision = raw_input(prompt)

while True:
    if not self.decision or self.decision.lower() == 'r':
        return tlspinning.DecisionType.REJECT
    elif self.decision.lower() == 'p' and self.pinning_file:
        return tlspinning.DecisionType.ACCEPT_AND_PIN
    elif self.decision.lower() == 'o':
        return tlspinning.DecisionType.ACCEPT_ONCE
    else:
        self.decision = raw_input(prompt)
</pre>
</div>
<p>Upon a successful connection, a session is established and a handle is returned in the form of a SessionHandle. When a session is in the connected state, its configuration cannot be modified. The session handle may be used to query information about the session. Here, we use it to get the session's ID, which will be needed when we want to reconnect to the session.</p>
<div class="source"><pre class="prettyprint">    log = logging.getLogger('onep:SessionTutorial')
    log.setLevel(logging.INFO)
    retry = 3
    app_terminate = False

    def handle_event(self, event, data):

        self.log.info(&quot;\n********* CONNECT LISTENER *******&quot;)
        self.log.info('Received connection event %s',
                      event.elem.OnepSessionState.enumval(event.state))

        if self.app_terminate:
            self.log.info(&quot;\n********* TUTORIAL TERMINATED *******&quot;)
            return

        if event.state == event.elem.OnepSessionState.ONEP_STATE_DISCONNECTED:
            if not self.retry:
                self.log.info(&quot;\n********* RECONNECT RETRY MAX FOR %d *******&quot; % data['id'])
                event.elem.set_connection_listener(None, None)
                return
            try:
                self.log.info(&quot;\n********* RECONNECT SESSION %d *******&quot; % data['id'])
                event.elem.reconnect(data['user'], data['pwd'],
                                     data['id'], data['sess'])
            except Exception as e:
                self.retry -= 1
                self.log.info(&quot;\n********* RECONNECT FAILED SESSION %d*******&quot; %data['id'])
                self.log.info(&quot;\n********* %s *******&quot; % str(e))
</pre>
</div>
<p>Build a listener class to react to application connection events. The connection listener will be registered directly to the instantiated NetworkElement class.</p>
<p>In this example we have setup a log to send messages to the application logger. We have also added a maximum reconnect retry count and a flag to tell the listener when the application wants to exit without a reconnect attempt.</p>
<div class="source"><pre class="prettyprint">sessionID = originalSessionHandle._id
</pre>
</div>
<p>The session handle can also be used to get properties of the session and statistics about the session. Here, we just print them out.</p>
<div class="source"><pre class="prettyprint"> #  Get the property instance for this session using the
 #  session handle.
 # 
 property = handle.sessionProp

 #  Get the port number the session is connected on. 
 logger.info(&quot;Port: &quot; + str(property.port))
 #  Get the event queue size of the session. 
 logger.info(&quot;EventQueueSize: &quot; + str(property.eventQueueSize))
 #  Get the event thread pool size of the session. 
 logger.info(&quot;EventThreadPool: &quot; + str(property.eventThreadPool))
 #  Get the event drop mode of the session. 
 logger.info(&quot;EventDropMode: &quot; + str(property.eventDropMode))
 #  Get the reconnect timer of the session in seconds. 
 logger.info(&quot;ReconnectTimer: &quot; + str(property.reconnectTimer))
 #  Get the transport mode of the session. 
 logger.info(&quot;TransportMode: &quot; + str(property.transportMode))
</pre>
</div>
<div class="source"><pre class="prettyprint">#  Get the statistics instance for this session using the
#  session handle.
#          
statistics = handle.sessionStat
#  Get the count of events received and dropped. 
logger.info(&quot;Events Total: %s&quot;, statistics.eventTotalCount)
logger.info(&quot;\nEvents Dropped: %s&quot;, statistics.eventDropCount)
</pre>
</div>
<div class="source"><pre class="prettyprint">con_listener = TutorialReconnectListener()
tutorial.get_network_element().set_connection_listener(con_listener,
                                                       {'user': tutorial.get_username(),
                                                        'pwd': tutorial.get_password(),
                                                        'id': sessionID,
                                                        'sess' : config})
</pre>
</div>
<p>Register your connection listener to the network element.</p>
</div>
</div>
<div class="section"><h2><a name="Result">Result</a></h2>
<p>Congratulations! You have configured a session, read the properties and statistics of a session, and reconnected to a session.</p>
<p>To try out this tutorial code by compiling and running it, you can find the code located at: &lt;SDK Location&gt;/python/tutorials/session/.</p>
</div>
<div class="section"><h2><a name="Next_Steps">Next Steps</a></h2>
<ul><li><a href="../Policy/policy.html">Policy Tutorials</a></li>
<li><a href="../Events/events.html">Events Tutorials</a></li>
<li><a href="../NetworkInterface/networkinterface.html">Network Interface Tutorials</a></li>
</ul>
</div>

                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2014.
          All Rights Reserved.      
            
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
